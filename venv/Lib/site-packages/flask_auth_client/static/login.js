(function () {
    'use strict';
    var loginForm = document.getElementById('loginForm');
    var authServiceUrl = loginForm.dataset.authUrl;
    var loginMessage = document.getElementById('loginMessage');
    var authenticatingMessage = document.getElementById('authenticatingMessage');
    var formFieldset = document.getElementById('fields');

    function submitToken(token) {
        var tokenForm = document.getElementById('tokenForm');
        tokenForm.elements['token'].value = token;
        var params = new URLSearchParams(location.search.slice(1));
        var referrer = params.get("referrer")
        tokenForm.elements['redirect'].value = referrer;
        tokenForm.submit();
    }

    // Fetch any previously set token from the auth-service
    fetch(authServiceUrl + '/token', {method: 'GET', credentials: 'include', mode: 'cors'}).then(function(response) {
        if (response.status == 200) {
            response.text().then(submitToken);
        } else {
            // Show the login form
            loginForm.style.display = 'block';
            authenticatingMessage.style.display = 'none';
        }
    });
    loginForm.addEventListener('submit', function (event) {
        event.preventDefault();
        var formData = new FormData(loginForm);
        formFieldset.disabled = true;
        fetch(authServiceUrl + '/token',
            {method: 'POST', body: formData, mode: 'cors'}
        ).then(function (response) {
            if (response.status == 200) {
                response.text().then(submitToken);
            } else {
                loginMessage.style.display = "block";
                formFieldset.disabled = false;
            }
        });
    });
})();
